<!DOCTYPE html>
<html>
<head>
    <title>Recherche de Parking à Vélo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <style>
        #map { height: 400px; width: 100%; }
        #address, #coordinates { width: 100%; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

<h3>Entrez l'adresse :</h3>
<input type="text" id="address" placeholder="Exemple : 189 Boulevard Voltaire, Paris">
<button id="submitAddress">Rechercher par adresse</button>

<h3>Entrez vos coordonnées :</h3>
<input type="text" id="coordinates" placeholder="Exemple : 48.8566, 2.3522">
<button id="submitCoordinates">Rechercher par coordonnées</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    var map = L.map('map').setView([48.8566, 2.3522], 13); // Paris par défaut

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var marker;

    document.getElementById('submitAddress').addEventListener('click', function() {
        var address = document.getElementById('address').value;
        var photonAPI = "https://photon.komoot.io/api/?q=" + encodeURIComponent(address);
    
        axios.get(photonAPI)
            .then(function (response) {
                if(response.data.features.length > 0) {
                    var coords = response.data.features[0].geometry.coordinates;
                    var nominatimAPI = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[1]}&lon=${coords[0]}&zoom=18&addressdetails=1`;
    
                    axios.get(nominatimAPI).then(function(nominatimResponse) {
                        var addressDetails = nominatimResponse.data.address;
                        var formattedAddress = `${addressDetails.road || ''}, ${addressDetails.house_number || ''}, ${addressDetails.postcode || ''} ${addressDetails.city || ''}, ${addressDetails.country || ''}`;
                        map.setView([coords[1], coords[0]], 13);
                        if (marker) {
                            map.removeLayer(marker);
                        }
                        marker = L.marker([coords[1], coords[0]]).addTo(map)
                            .bindPopup(formattedAddress)
                            .openPopup();
                    }).catch(function(nominatimError) {
                        console.log(nominatimError);
                    });
                } else {
                    alert("Adresse non trouvée.");
                }
            })
            .catch(function (error) {
                console.log(error);
            });
    });

    document.getElementById('submitCoordinates').addEventListener('click', function() {
        var coordsInput = document.getElementById('coordinates').value.split(',');
        var lat = parseFloat(coordsInput[0].trim());
        var lng = parseFloat(coordsInput[1].trim());

        if (!isNaN(lat) && !isNaN(lng)) {
            var nominatimAPI = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;

            axios.get(nominatimAPI)
                .then(function(response) {
                    var addressDetails = response.data.address;
                    var formattedAddress = `${addressDetails.road || ''}, ${addressDetails.house_number || ''}, ${addressDetails.postcode || ''} ${addressDetails.city || ''}, ${addressDetails.country || ''}`;
                    map.setView([lat, lng], 13);
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([lat, lng]).addTo(map)
                        .bindPopup(formattedAddress)
                        .openPopup();
                })
                .catch(function(error) {
                    console.log(error);
                });
        } else {
            alert("Coordonnées invalides.");
        }
    });
</script>

</body>
</html>
